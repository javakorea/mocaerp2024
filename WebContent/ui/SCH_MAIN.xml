<html xmlns="http://www.w3.org/1999/xhtml" xmlns:ev="http://www.w3.org/2001/xml-events" xmlns:w2="http://www.inswave.com/websquare"
	xmlns:xf="http://www.w3.org/2002/xforms">

	<head>
		<w2:type>COMPONENT</w2:type>
		<w2:buildDate />
		<w2:MSA />
		<xf:model>
			<w2:dataCollection baseNode="map">
				<w2:dataList baseNode="list" id="dlt_list" repeatNode="map" saveRemovedData="true">
					<w2:columnInfo>
						<w2:column dataType="text" id="SCH_IDX" name="SCH_IDX" />
						<w2:column dataType="text" id="SCH_CATEGORY" name="SCH_CATEGORY" />
						<w2:column id="SCH_TITLE2" name="SCH_TITLE2" dataType="text"></w2:column>
						<w2:column dataType="text" id="SCH_TITLE" name="SCH_TITLE" />
						<w2:column dataType="text" id="SCH_CONT" name="SCH_CONT" />
						<w2:column dataType="text" id="SCH_WRITER" name="SCH_WRITER" />
						<w2:column id="SCH_CREATE_DTTM" name="SCH_CREATE_DTTM" dataType="text"></w2:column>
						<w2:column id="SCH_CURRENTMONTH" name="SCH_CURRENTMONTH" dataType="text"></w2:column>
						<w2:column id="SCH_START" name="SCH_START" dataType="text"></w2:column>
						<w2:column id="SCH_END" name="SCH_END" dataType="text"></w2:column>
						<w2:column id="SCH_START_UTC" name="SCH_START_UTC" dataType="text"></w2:column>
						<w2:column id="SCH_END_UTC" name="SCH_END_UTC" dataType="text"></w2:column>


						<w2:column id="SCH_COLOR" name="SCH_COLOR" dataType="text"></w2:column>
						<w2:column id="FUL_COLOR" name="FUL_COLOR" dataType="text" importFormatter="scwin.fn_format"></w2:column>


						<w2:column id="SCH_DELYN" name="SCH_DELYN" dataType="text"></w2:column>
						<w2:column id="SCH_SENDYN" name="SCH_SENDYN" dataType="text"></w2:column>
						<w2:column id="SCH_SUCCESSYN" name="SCH_SUCCESSYN" dataType="text"></w2:column>
					</w2:columnInfo>
					<w2:data use="false"></w2:data>
				</w2:dataList>
				<w2:dataMap baseNode="map" id="dma_search">
					<w2:keyInfo>
						<w2:key id="SCH_CURRENTMONTH_PREV" name="SCH_CURRENTMONTH_PREV" dataType="text"></w2:key>
						<w2:key id="SCH_CURRENTMONTH" name="SCH_CURRENTMONTH" dataType="text"></w2:key>
						<w2:key id="SCH_CURRENTMONTH_NEXT" name="SCH_CURRENTMONTH_NEXT" dataType="text"></w2:key>
						
						<!-- 공통부 -->
						<w2:key id="COMMON_TRAN_ID" 			name="TRAN_ID" 						dataType="text"></w2:key>
						<w2:key id="COMMON_STATUS" 				name="CRUD_상태" 						dataType="text"></w2:key>
						<w2:key id="COMMON_QUERY" 				name="SELECT_QUERY" 				dataType="text"></w2:key>
						<w2:key id="COMMON_MASTER_QUERY" 		name="COMMON_MASTER_QUERY" 			dataType="text"></w2:key>
						<w2:key id="COMMON_MASTER_DELETEQUERY" 	name="COMMON_MASTER_DELETEQUERY" 	dataType="text"></w2:key>
						<w2:key id="COMMON_DETAIL_INSERTQUERY" 	name="SUBQUERY" 					dataType="text"></w2:key>
						<w2:key id="COMMON_DETAIL_UPDATEQUERY" 	name="SUBQUERY" 					dataType="text"></w2:key>
						<w2:key id="COMMON_DETAIL_DELETEQUERY" 	name="SUBQUERY" 					dataType="text"></w2:key>
						<w2:key id="COMMON_MASTER_KEY" 			name="COMMON_MASTER_KEY" 			dataType="text"></w2:key>
						<w2:key id="COMMON_DETAIL_KEY" 			name="COMMON_DETAIL_KEY" 			dataType="text"></w2:key>						
					</w2:keyInfo>
				</w2:dataMap>
			</w2:dataCollection>
			<w2:workflowCollection></w2:workflowCollection>
			<xf:submission 
				id="sbm_schdList" ref="data:json,dma_search" target="data:json,dlt_list" 
				action="/selectList.do" ev:submitdone="scwin.sbm_schdList_submitdone"
				method="post" mediatype="application/json" encoding="UTF-8" instance="" replace="" errorHandler="" customHandler="" mode="asynchronous"
				processMsg="" ev:submit="" ev:submiterror="" abortTrigger="">
			</xf:submission>
		</xf:model>

		<w2:layoutInfo>
		</w2:layoutInfo>

		<w2:publicInfo method="" />
		<script lazy="false" type="text/javascript"><![CDATA[scwin.yoil = {일요일:0,월요일:1,화요일:2,수요일:3,목요일:4,금요일:5,토요일:6};
scwin.dayMap = {};
scwin.onpageload = function() {
	let thisMonth = WebSquare.date.getCurrentServerDate('yyyyMM');
	SCH_CURRENTMONTH.setValue(thisMonth);

	scwin.left = wfm_cal_prev;
	scwin.center = wfm_cal;
	scwin.right = wfm_cal_next;	
	gcm.ext.swiper.scriptImport(function(e){
		scwin.swiper = new Swiper(".mySwiperNew", {
			slidesPerView: 1,
			loop: true
		});
		scwin.swiper.on('realIndexChange', function (_swiperObj) {
			let selectedCalObj = $p.getComponentById(scwin.swiper.slides[scwin.swiper.activeIndex].id);
			let basisMonth = selectedCalObj.scope.grp_yyyyMM.render.innerText.replace(/년|월/g,'');
			SCH_CURRENTMONTH.setValue(basisMonth);
			if(selectedCalObj.org_id == 'wfm_cal_prev'){
				scwin.left = wfm_cal_next;
				scwin.center = wfm_cal_prev;
				scwin.right = wfm_cal;
			}else if(selectedCalObj.org_id == 'wfm_cal'){
				scwin.left = wfm_cal_prev;
				scwin.center = wfm_cal;
				scwin.right = wfm_cal_next;
			}else if(selectedCalObj.org_id == 'wfm_cal_next'){
				scwin.left = wfm_cal;
				scwin.center = wfm_cal_next;
				scwin.right = wfm_cal_prev;		
			}			
			scwin.search();
		});
		scwin.swiper.slideTo(1,0);//아이폰을위해서 (realIndexChange발생)
	});	
}
scwin.left = null;
scwin.center = null;
scwin.right = null;
scwin.search = function(){
	scwin.setBgColor();
	scwin.threeCalDraw();
};

scwin.threeCalDraw = function(){
	var yyyyMM 			= SCH_CURRENTMONTH.getValue();
	var yyyyMM_prev 	= WebSquare.date.dateTimeAdd( yyyyMM, -1, "month" );
	var yyyyMM_next 	= WebSquare.date.dateTimeAdd( yyyyMM, 1, "month" );

	scwin.center.scope.grp_yyyyMM.render.innerText = yyyyMM.substring(0,4)+'년'+yyyyMM.substring(4)+'월';
	scwin.left.scope.grp_yyyyMM.render.innerText = yyyyMM_prev.substring(0,4)+'년'+yyyyMM_prev.substring(4)+'월';
	scwin.right.scope.grp_yyyyMM.render.innerText = yyyyMM_next.substring(0,4)+'년'+yyyyMM_next.substring(4)+'월';	

	dma_search.set('SCH_CURRENTMONTH_PREV',yyyyMM_prev);
	dma_search.set('SCH_CURRENTMONTH',yyyyMM);
	dma_search.set('SCH_CURRENTMONTH_NEXT',yyyyMM_next);


	dma_search.set('COMMON_QUERY',"M.selectScheduleList");
	com.sbm.execute(sbm_schdList);
	scwin.sbm_schdList_submitdone = function(e) {
		scwin.dayMap = {};
		let list = e.responseJSON.dlt_list;
		for(let i=0; i < list.length; i++){
			let c = list[i];
			let day = c.SCH_START.substring(0,10).replace(/-/g,'');
			let _key = WebSquare.date.dateTimeAdd( day, 1, "day" );
			let aDayList = scwin.dayMap[_key];
			if(!aDayList){
				aDayList = [];
			}
			aDayList.push(c);
			scwin.dayMap[_key] = aDayList;
		}
		scwin.draw(yyyyMM,scwin.center.scope);
		//scwin.draw(yyyyMM_prev,scwin.left.scope);
		//scwin.draw(yyyyMM_next,scwin.right.scope);
	};
}

scwin.draw = function(yyyyMM,_scope) {
	let startDay = yyyyMM+'01';
	let startWeekDay = scwin.yoil[WebSquare.date.getDay(startDay)];
	var yyyyMM_next = WebSquare.date.dateTimeAdd( yyyyMM, 1, "month" );
	let daysInMon = WebSquare.date.dateDiff(yyyyMM+'01',yyyyMM_next+'01');

	var yyyyMM_prev 	= WebSquare.date.dateTimeAdd( yyyyMM, -1, "month" );
	let daysInMon_prev 	= WebSquare.date.dateDiff(yyyyMM_prev+'01',yyyyMM+'01');

	let isStart = -1;
	let writeDay = 1;
	for(let i=0; i < 6;i++){
		for(let j=0; j < 7; j++){
			let dayDiv = _scope.$p.getComponentById('cell' + i + '' + j);
			let _spa = dayDiv.childControlList[0];
			let _contents = dayDiv.childControlList[1];
			_spa.removeClass("on");
			if(i == 0 && j == startWeekDay){
				isStart = 0;
			}else if(i == 0 && isStart == -1 && j != startWeekDay){
				
				let reday = daysInMon_prev-((startWeekDay-1)-j);
				_spa.setLabel(reday);					dayDiv.setAttribute('yyyyMMdd',yyyyMM_prev+((reday<10)? '0'+reday:reday)	);
				
			}
			if(isStart == 0){
				_spa.addClass("on");
				_spa.setLabel(writeDay);				dayDiv.setAttribute('yyyyMMdd',yyyyMM+((writeDay<10)? '0'+writeDay:writeDay)  );
				writeDay++;
				if(writeDay > daysInMon){
					isStart = 1;
					writeDay = 0;
				}
			}else if(isStart == 1){
				writeDay++;
				_spa.setLabel(writeDay);				dayDiv.setAttribute('yyyyMMdd',yyyyMM_next+((writeDay<10)? '0'+writeDay:writeDay));
			}
			let o = scwin.dayMap[dayDiv.getAttribute('yyyyMMdd')];
			if(o){
				let str = '';
				for(let i=0; i < o.length; i++){
					let aDaySc = o[i];
					str += "<span class='sch_bar'>"+aDaySc['SCH_TITLE']+"</span>";
				}
				_contents.render.innerHTML = str;
			}else{
				_contents.render.innerHTML = "";				
			}
			
		}		
	}
	
	
	
	
}

scwin.btn_left_onclick = function(e) {
	SCH_CURRENTMONTH.setValue(WebSquare.date.dateTimeAdd( SCH_CURRENTMONTH.getValue(), -1, "month" ));
	scwin.search();	
};


scwin.btn_right_onclick = function(e) {
	SCH_CURRENTMONTH.setValue(WebSquare.date.dateTimeAdd( SCH_CURRENTMONTH.getValue(), 1, "month" ));
	scwin.search();	
};

scwin.selectedCell = null;
scwin.setBgColor = function(_obj) {
	let cellBgColor = '#ffca00';
    if(scwin.selectedCell){
    	scwin.selectedCell.setStyle('background-color','');
    	scwin.hideAdayList();
    }
	if(_obj){
		_obj.setStyle('background-color',cellBgColor);
		scwin.selectedCell = _obj;
	}
};
scwin.showAdayList = function(_thisObj) {
	wfm_pop.setSrc('/ui/SCH_POP_LST.xml');
};
scwin.hideAdayList = function() {
	grp_adayList.hide();
	wfm_pop.setSrc('');
};
scwin.popupAdayList = function() {
	scwin.hideAdayList();
};







scwin.display = function(_yyyyMM){
	return _yyyyMM.substring(0,4)+'년'+_yyyyMM.substring(4,6)+'월';
}
scwin.SCH_CURRENTMONTH_onviewchange = function(info) {
	scwin.search();	
};
]]></script>
		<style>
		</style>
	</head>
	<body ev:onpageload="scwin.onpageload">

		<xf:group id="" class="sub_contents flex_gvw flex_m" style="background:#f4f5f9">
			<xf:group id="grp_cal" class="sch_wrap">
				<xf:group id="" class="sch_titleArea">
					<xf:group id="grp_adayList" 
					style="display:none;text-align:right;z-index:9999;position: absolute;left: 0px;top: 0px;width: 90%;height:100%;bottom:30px;background-color:#f9fe9d;border-color:lightgrey;border-width:1px;border-style:solid;">
						<xf:group id="" class="fl" style="height:100%">
							<xf:trigger ev:onclick="scwin.popupAdayList" style="width:60px;height:100%" id="btn_adayListClose" type="button" class="btn_sch ">
								<xf:label><![CDATA[닫기]]></xf:label>
							</xf:trigger>
						</xf:group>
						<xf:group style="text-align:left;display: block;font-size: 24px;height:100%;" id="grp_list" tagname="div" class="">
							<w2:wframe src="" style="width: 100%;height:100%;" id="wfm_pop" class=""></w2:wframe>
						</xf:group>
					</xf:group>
					<xf:group id="" class="fl">
						<xf:trigger ev:onclick="scwin.btn_left_onclick" style="" id="btn_left" type="button" class="btn_sch ">
							<xf:label><![CDATA[〈]]></xf:label>
						</xf:trigger>
					</xf:group>
					<xf:group style="" id="grp_yyyyMM" tagname="div" class="sch_tit">
						<xf:input displayFormatter="scwin.display" ev:onviewchange="scwin.SCH_CURRENTMONTH_onviewchange" style=""
							id="SCH_CURRENTMONTH">
						</xf:input>
					</xf:group>
					<xf:group id="" class="fr">
						<xf:trigger ev:onclick="scwin.btn_right_onclick" style="" id="btn_right" type="button" class="btn_sch">
							<xf:label><![CDATA[〉]]></xf:label>
						</xf:trigger>
					</xf:group>
				</xf:group>
				<xf:group class="swiper mySwiperNew">
					<xf:group style="height:100%;flex-flow:nowrap;" id="" class="calendarbox flex swiper-wrapper">
						<w2:wframe src="SCH_WFM_CAL.xml" style="width: 100%;" id="wfm_cal_prev" class="swiper-slide"></w2:wframe>
						<w2:wframe src="SCH_WFM_CAL.xml" style="width: 100%;" id="wfm_cal" class="swiper-slide"></w2:wframe>
						<w2:wframe src="SCH_WFM_CAL.xml" style="width: 100%;" id="wfm_cal_next" class="swiper-slide"></w2:wframe>
					</xf:group>
				</xf:group>
			</xf:group>
		</xf:group>









		
	</body>
</html>
